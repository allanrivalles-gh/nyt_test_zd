package com.theathletic.compass.codegen

import com.theathletic.BuildConfig
import com.theathletic.compass.CompassClient
import com.theathletic.compass.Experiment
import com.theathletic.compass.FieldResponse
import com.theathletic.compass.Variant
import com.theathletic.debugtools.DebugPreferences
import com.theathletic.utility.logging.ICrashLogHandler
import com.theathletic.user.UserManager
import kotlin.Boolean
import kotlin.Long
import kotlin.String
import kotlin.collections.Map

/**
 * This class was generated by the 'compass' plugin
 */
class TestEmptyFieldExperiment(
    override var name: String = "empty field experiment",
    override var exists: Boolean = false,
    override var activeVariant: Variant? = EmptyFieldExperimentVariant.CTRL(),
    override val crashLogHandler: ICrashLogHandler,
    override val debugPreferences: DebugPreferences
) : Experiment() {
  /**
   * Returns the active variant indicated by the server config, or CTRL if not able to obtain a
   * config
   */
  val variant: EmptyFieldExperimentVariant
    get() {
      if (client == null || client?.configState?.get() != CompassClient.ConfigState.POPULATED) {
        val exception = IllegalAccessException("""The compass client configState must be POPULATED
          in order to reference a variant""")
        if (BuildConfig.DEBUG) {
          throw exception
        } else {
          crashLogHandler.logException(exception)
        }
      }

      if (debugPreferences.compassSelectedVariantMap[name] != null) {
        return when(debugPreferences.compassSelectedVariantMap[name]) {
          "A" -> EmptyFieldExperimentVariant.A()
          "B" -> EmptyFieldExperimentVariant.B()
          else -> EmptyFieldExperimentVariant.CTRL()
        }
      }

      if (exists) {
        return activeVariant as EmptyFieldExperimentVariant
      }

      return EmptyFieldExperimentVariant.CTRL()
    }

  override fun copy(activeVariant: Variant, exists: Boolean) =
      TestEmptyFieldExperiment(activeVariant = activeVariant, exists = exists, crashLogHandler =
      crashLogHandler, debugPreferences = debugPreferences)

  fun postExposure(userId: Long = UserManager.getCurrentUserId()) {
    client?.postExposure(this, userId)
  }

  sealed class EmptyFieldExperimentVariant : Variant {
    data class CTRL(
      override val _name: String = "CTRL"
    ) : EmptyFieldExperimentVariant() {
      override fun populateFromFieldMap(fieldMap: Map<String, FieldResponse>,
          crashLogHandler: ICrashLogHandler) = CTRL(
      )
    }

    data class A(
      override val _name: String = "A"
    ) : EmptyFieldExperimentVariant() {
      override fun populateFromFieldMap(fieldMap: Map<String, FieldResponse>,
          crashLogHandler: ICrashLogHandler) = A(
      )
    }

    data class B(
      override val _name: String = "B"
    ) : EmptyFieldExperimentVariant() {
      override fun populateFromFieldMap(fieldMap: Map<String, FieldResponse>,
          crashLogHandler: ICrashLogHandler) = B(
      )
    }
  }
}
